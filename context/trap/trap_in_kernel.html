<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.3. Kernel与异常 &mdash; 龙芯实验室文档 V1.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=b01b2dd9" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />

  
    <link rel="shortcut icon" href="../../_static/favicon.jpg"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=3f0bcac8"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
        <script src="../../_static/translations.js?v=beaddf03"></script>
        <script src="../../_static/design-tabs.js?v=f930bc37"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="6. SMP多核系统" href="../smp/index.html" />
    <link rel="prev" title="5.2. 例外" href="exception.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          <a href="../../index.html" class="icon icon-home">
            龙芯实验室文档
          </a>
              <div class="version">
                V1.0
              </div>
<div role="search">
  <form id="evas-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preparation/index.html">1. 准备工作</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../preparation/preface.html">1.1. 前言</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../preparation/preface.html#id2">1.1.1. 更新说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/preface.html#id3">1.1.2. 仓库地址</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../preparation/tools.html">1.2. 工具链说明</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#gcc">1.2.1. GCC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#llvm">1.2.2. LLVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#rust">1.2.3. Rust</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../preparation/tools.html#id2">1.3. 模拟器</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#qemu">1.3.1. QEMU</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#la-emu">1.3.2. LA_EMU</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../preparation/tools.html#id3">1.4. 操作系统编译</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#loongnix">1.4.1. LoongNix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#uos">1.4.2. UOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#deepin">1.4.3. Deepin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#aosc">1.4.4. AOSC(安同)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../preparation/tools.html#linux-kernel">1.4.5. Linux kernel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../toolchains/index.html">2. 工具链</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../toolchains/gcc.html">2.1. GCC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/gcc.html#id1">2.1.1. GCC的相关概念</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#id2">2.1.1.1. GCC的基本定义与起源</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#id4">2.1.1.2. GCC支持的语言与平台</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#id5">2.1.1.3. GCC的核心功能与特点</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#id6">2.1.1.4. GCC的最新进展</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#id7">2.1.1.5. GCC的应用场景</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/gcc.html#id8">2.1.2. 交叉编译器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/gcc.html#id9">2.1.3. 常见的类别组合</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/gcc.html#id12">2.1.4. 如何编译交叉编译器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#loongarch64-linux-gnu-sf">2.1.4.1. 如何编译loongarch64-linux-gnu[sf]</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#loongarch64-linux-musl-sf">2.1.4.2. 如何编译loongarch64-linux-musl[sf]</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#crtn-crti-crtbegin-crtend">2.1.4.3. crtn, crti, crtbegin, crtend有什么区别</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/gcc.html#id22">2.1.5. 常用的参数与选项</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#id23">2.1.5.1. GCC常见的参数</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#picpie">2.1.5.2. PIC与PIE的区别是什么</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#loongarch">2.1.5.3. 与LoongArch相关的选项说明</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/gcc.html#c-c">2.1.5.4. C/C++ 预处理器内嵌的宏定义</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../toolchains/binutils.html">2.2. Binutils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/binutils.html#gnu-binutils">2.2.1. GNU Binutils的相关说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id1">2.2.1.1. <strong>核心定位与背景</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id2">2.2.1.2. <strong>重要组成部分与功能</strong></a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id5">2.2.1.3. <strong>应用场景</strong></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/binutils.html#ld">2.2.2. ld链接器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id6">2.2.2.1. LD的参数说明</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/binutils.html#readelf">2.2.3. 如何正确的使用readelf</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id7">2.2.3.1. 基础用法与核心选项</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id11">2.2.3.2. 二、高级用法</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id14">2.2.3.3. 三、实战示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id18">2.2.3.4. 四、与其他工具对比</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/binutils.html#objdump">2.2.4. objdump</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id19">2.2.4.1. 一、基础用法与核心选项</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id25">2.2.4.2. 二、高级用法</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id31">2.2.4.3. 三、典型应用场景</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id36">2.2.4.4. 四、与其他工具对比</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id37">2.2.4.5. 五、注意事项</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id38">2.2.4.6. 六、实战示例</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/binutils.html#objcopy">2.2.5. objcopy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id42">2.2.5.1. 一、基础用法与核心选项</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id46">2.2.5.2. 二、高级功能</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id51">2.2.5.3. 三、参数详解</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id52">2.2.5.4. 四、典型应用场景</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id56">2.2.5.5. 五、常见问题与解决</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id60">2.2.5.6. 六、与其他工具对比</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/binutils.html#id61">2.2.5.7. 七、总结</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../toolchains/rust.html">2.3. Rust</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/rust.html#id1">2.3.1. Rust的概念</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/rust.html#id2">2.3.1.1. Rust的起源与发展</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/rust.html#id3">2.3.1.2. Rust的核心特性</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/rust.html#id4">2.3.1.3. Rust的应用场景</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/rust.html#id5">2.3.1.4. Rust的最新进展</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/rust.html#id6">2.3.1.5. Rust的优缺点</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/rust.html#loongarchtarget">2.3.2. LoongArch支持的target有哪些</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/rust.html#loongarch">2.3.3. 与LoongArch相关的具体参数那些</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/rust.html#laexe">2.3.4. 简单的例子说明如何编译成LA架构的EXE文件</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../toolchains/builtin.html">2.4. 内嵌的函数与指令包装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/builtin.html#gcc">2.4.1. GCC</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/builtin.html#llvm">2.4.2. LLVM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/builtin.html#rust">2.4.3. Rust</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/builtin.html#loongarch">2.4.3.1. LoongArch包的相关内容</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../toolchains/assembly.html">2.5. 汇编代码与链接脚本</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/assembly.html#loongarch">2.5.1. 与LoongArch相关的汇编指令</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id2">2.5.1.1. 伪汇编指令</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id3">2.5.1.2. 地址加载指令</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id4">2.5.1.3. 内嵌汇编</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id5">2.5.1.4. 参考阅读</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/assembly.html#id6">2.5.2. 链接脚本</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id7">2.5.2.1. 一、基础语法结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id8">2.5.2.2. 二、核心命令与操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id13">2.5.2.3. 三、高级功能</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id17">2.5.2.4. 四、典型应用场景</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id21">2.5.2.5. 五、实战示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id24">2.5.2.6. 六、调试与验证</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id25">2.5.2.7. 七、总结</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/assembly.html#id26">2.5.2.8. 以LoongArch为例说明链接脚本</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../toolchains/library.html">2.6. 一些常用的库函数</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/library.html#glibc">2.6.1. GLIBC</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/library.html#id2">2.6.1.1. 一、核心功能与作用</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/library.html#id3">2.6.1.2. 二、架构与实现细节</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/library.html#id4">2.6.1.3. 三、版本演进与升级风险</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/library.html#id5">2.6.1.4. 四、与其他运行库的对比</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/library.html#id6">2.6.1.5. 五、开发与调试工具</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/library.html#musl">2.6.2. MUSL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/library.html#musl-c">2.6.2.1. Musl C 库详解</a></li>
<li class="toctree-l4"><a class="reference internal" href="../toolchains/library.html#id15">2.6.2.2. 总结</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/library.html#memcpy">2.6.3. memcpy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/library.html#memmove">2.6.4. memmove</a></li>
<li class="toctree-l3"><a class="reference internal" href="../toolchains/library.html#memset">2.6.5. memset</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../privilege_isa/index.html">3. 特权态指令</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/csr.html">3.1. CSR寄存器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/csr.html#id1">3.2. CSR指令</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/csr.html#csrrd">3.2.1. CSRRD指令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/csr.html#csrwr">3.2.2. CSRWR指令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/csr.html#csrxchg">3.2.3. CSRXCHG指令</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/csr.html#iocsr">3.3. IOCSR指令</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/csr.html#iocsrrd">3.3.1. IOCSRRD指令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/csr.html#iocsrwr">3.3.2. IOCSRWR指令</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/cacop_insn.html">3.4. CPUCFG 指令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/cacop_insn.html#cacop">3.5. CACOP 指令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/tlb_insn.html">3.6. TLB 与页表指令</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/tlb_insn.html#id1">3.6.1. TLB 相关指令</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#tlbsrch">3.6.1.1. TLBSRCH</a></li>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#tlbrd">3.6.1.2. TLBRD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#tlbwr">3.6.1.3. TLBWR</a></li>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#tlbfill">3.6.1.4. TLBFILL</a></li>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#tlbclr">3.6.1.5. TLBCLR</a></li>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#tlbflush">3.6.1.6. TLBFLUSH</a></li>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#invtlb">3.6.1.7. INVTLB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/tlb_insn.html#id2">3.6.2. 页表查找指令</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#lddir">3.6.2.1. LDDIR</a></li>
<li class="toctree-l4"><a class="reference internal" href="../privilege_isa/tlb_insn.html#ldpte">3.6.2.2. LDPTE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../privilege_isa/tlb_insn.html#id3">3.6.3. 应用示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/misc_insn.html">3.7. ERTN指令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/misc_insn.html#idle">3.8. IDLE指令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../privilege_isa/misc_insn.html#syscall">3.9. SysCALL指令</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mmu/index.html">4. 内存管理</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../mmu/tlb_struct.html">4.1. LoongArch的地址管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#id2">4.1.1. 直接地址翻译模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#id3">4.1.2. 映射地址翻译模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#id4">4.1.3. 存储访问的类型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mmu/tlb_struct.html#loongarchtlb">4.2. LoongArch的TLB结构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#id5">4.2.1. 逻辑组织结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#tlb-cpu">4.2.2. TLB的表项（以CPU的视觉）</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mmu/tlb_struct.html#tlb">4.3. TLB的管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#id6">4.3.1. TLB的一些概念区分</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#id7">4.3.2. TLB相关的指令</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#tlbcsr">4.3.3. TLB相关的CSR</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#tlb-excption-handle">4.3.4. TLB相关的例外</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_struct.html#cputlb">4.3.5. CPU内部TLB查找流程示例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mmu/dmw.html">4.4. 直接映射翻译模式</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mmu/dmw.html#csr-dmw-0-3">4.4.1. CSR.DMW[0-3]</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/dmw.html#id2">4.4.2. 操作系统中如何使用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../mmu/dmw.html#dmw">4.4.2.1. DMW的优点</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/dmw.html#id3">4.4.2.2. DMW的缺点</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/dmw.html#id4">4.4.2.3. 代码示例如何在内核中使用</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mmu/tlb_ptw.html">4.5. 多级页表结构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_ptw.html#id2">4.5.1. 设计背景与必要性</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id3">4.5.1.1. 多级页表的结构与层级</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id4">4.5.1.2. 地址转换流程</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id5">4.5.1.3. 多级页表的优势</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id6">4.5.1.4. 优化机制</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id7">4.5.1.5. 对比不同架构的页表设计</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_ptw.html#loongarch">4.5.2. LoongArch的多级页表结构</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#kernel">4.5.2.1. Kernel如何初始化设置多级页表结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#kb">4.5.2.2. 二级页表，4KB页大小</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id8">4.5.2.3. 二级页表，16KB页大小</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id9">4.5.2.4. 三级页表，4KB页大小</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id10">4.5.2.5. 三级页表，16KB页大小</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id11">4.5.2.6. 四级页表，4KB页大小</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id12">4.5.2.7. 四级页表，16KB页大小</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_ptw.html#id13">4.5.3. 内存中的页表表项（Kernel视角）</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id14">4.5.3.1. 基本页表（叶子节点）</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id15">4.5.3.2. 大页页表（叶子节点）</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#no-leaf-pg-entry">4.5.3.3. 中间指向下一级目录的地址的页表(非叶子节点页表)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_ptw.html#id17">4.5.4. 页表的遍历</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#k">4.5.4.1. 以一个例子4K页为例说明：</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#m">4.5.4.2. 以一个例子2M页为例说明：</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mmu/tlb_ptw.html#cputlb">4.6. 从内存中的页表表项到CPU中的TLB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_ptw.html#tlbrefill-softeware-ptw">4.6.1. TLBRefill (Softeware PTW)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#csr">4.6.1.1. 相关的CSR寄存器</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id18">4.6.1.2. 重填示例代码</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id19">4.6.1.3. 两级页表的示例代码</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#three-level-page-table-refill">4.6.1.4. 三级页表的示例代码</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id21">4.6.1.5. 四级页表的示例代码</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_ptw.html#hardware-ptw">4.6.2. Hardware PTW</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/tlb_ptw.html#id22">4.6.3. 页表的刷新</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id23">4.6.3.1. 页表为什么需要刷新</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id24">4.6.3.2. 页表刷新的指令</a></li>
<li class="toctree-l4"><a class="reference internal" href="../mmu/tlb_ptw.html#id25">4.6.3.3. 页表刷新的例子</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../mmu/page_table_in_kernel.html">4.7. Kernel与MMU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#id1">4.7.1. 地址翻译相关的初始化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#id2">4.7.2. 如何从直接地址翻译模式到映射地址翻译模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#id3">4.7.3. 如何建立虚拟地址到物理地址的映射关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#id4">4.7.4. 页表的遍历页表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#tlb">4.7.5. 情况1. 如果TLB中没有映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#v-0">4.7.6. 情况2. 如果页表项的V=0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#d-0">4.7.7. 情况3. 如果写操作页表项D=0</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#id5">4.7.8. 情况4. 如果权限不合法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mmu/page_table_in_kernel.html#ptw">4.7.9. 如果使能硬件PTW</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">5. 中断与异常系统</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="interrupt.html">5.1. 中断</a><ul>
<li class="toctree-l3"><a class="reference internal" href="interrupt.html#id2">5.1.1. 线中断</a><ul>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#ipi">5.1.1.1. 核间中断IPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#id3">5.1.1.2. 定时器中断</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#id4">5.1.1.3. 性能计数器中断</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#id5">5.1.1.4. 外部硬中断</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#id6">5.1.1.5. 内部软中断</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#id7">5.1.1.6. 中断号</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="interrupt.html#id8">5.1.2. 消息中断</a></li>
<li class="toctree-l3"><a class="reference internal" href="interrupt.html#id9">5.1.3. 中断的优先级</a><ul>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#id10">5.1.3.1. 线中断的优先级</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt.html#id11">5.1.3.2. 消息中断的优先级</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="interrupt.html#id12">5.1.4. 中断的打开与关闭</a></li>
<li class="toctree-l3"><a class="reference internal" href="interrupt.html#id13">5.1.5. 中断的入口地址</a></li>
<li class="toctree-l3"><a class="reference internal" href="interrupt.html#id14">5.1.6. 中断的处理流程</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="exception.html">5.2. 例外</a><ul>
<li class="toctree-l3"><a class="reference internal" href="exception.html#id2">5.2.1. 例外的优先级</a></li>
<li class="toctree-l3"><a class="reference internal" href="exception.html#id3">5.2.2. 例外的入口地址</a></li>
<li class="toctree-l3"><a class="reference internal" href="exception.html#id4">5.2.3. 例外的处理过程</a><ul>
<li class="toctree-l4"><a class="reference internal" href="exception.html#id5">5.2.3.1. 普通例外的处理过程</a></li>
<li class="toctree-l4"><a class="reference internal" href="exception.html#tlb">5.2.3.2. TLB 重填例外硬件处理过程</a></li>
<li class="toctree-l4"><a class="reference internal" href="exception.html#id6">5.2.3.3. 机器错误例外硬件处理过程</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.3. Kernel与异常</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#expection-entry-selection">5.3.1. 异常的入口地址选择</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">5.3.1.1. “统一式”的入口地址</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">5.3.1.2. “分离式”的入口地址</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">5.3.2. 异常的初始化</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">5.3.2.1. 统一式的初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">5.3.2.2. 分离式的初始化</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cpu">5.3.3. 异常发生时，CPU做了什么</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id9">5.4. 特殊异常的处理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">5.4.1. 定时器中断</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">5.4.2. 系统调用</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">5.4.3. 非对齐访问</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../smp/index.html">6. SMP多核系统</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../smp/smp.html">6.1. SMP与LoongArch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../smp/smp.html#ipi">6.1.1. IPI中断</a></li>
<li class="toctree-l3"><a class="reference internal" href="../smp/smp.html#id1">6.1.2. 如何通信</a></li>
<li class="toctree-l3"><a class="reference internal" href="../smp/smp.html#id2">6.1.3. 如何初始化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../smp/smp.html#linuxsmp">6.2. Linux中SMP的处理（与架构相关）</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../abi/index.html">7. 程序二进制接口</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../abi/new_and_old_world.html">7.1. 新旧世界</a></li>
<li class="toctree-l2"><a class="reference internal" href="../abi/new_and_old_world.html#id2">7.2. 旧世界</a></li>
<li class="toctree-l2"><a class="reference internal" href="../abi/new_and_old_world.html#id3">7.3. 新世界</a></li>
<li class="toctree-l2"><a class="reference internal" href="../abi/new_and_old_world.html#id4">7.4. 新旧世界的区分</a></li>
<li class="toctree-l2"><a class="reference internal" href="../abi/abi.html">7.5. ABI 2.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../debug/index.html">8. 调试方法与技巧</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../debug/debug_env.html">8.1. LoongArch最小debug环境搭建</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../debug/debug_env.html#linux-ramdisk">8.1.1. 制作Linux RamDisk</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debug/debug_env.html#qemu">8.1.2. 如何在 QEMU 中调试</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debug/debug_env.html#id1">8.1.3. 设置断点</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../debug/debug_gdb.html">8.2. GDB的使用</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../debug/debug_gdb.html#id1">8.2.1. 交叉编译环境中的GDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debug/debug_gdb.html#id2">8.2.2. 常见的GDB命令示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debug/debug_gdb.html#id3">8.2.3. 调试指令常见失效状况</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../platform/index.html">9. 平台相关</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../platform/qemu.html">9.1. QEMU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/qemu.html#virt">9.1.1. Virt</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/qemu.html#id1">9.1.2. 设备</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform/3a5000.html">9.2. 3A5000芯片</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/3a5000.html#id1">9.2.1. 芯片参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/3a5000.html#id2">9.2.2. 芯片架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/3a5000.html#id3">9.2.3. 地址空间</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../platform/3a5000.html#id4">9.2.3.1. 结点间物理地址空间</a></li>
<li class="toctree-l4"><a class="reference internal" href="../platform/3a5000.html#id5">9.2.3.2. 结点内物理地址空间</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform/3a6000.html">9.3. 3A6000芯片</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/3a6000.html#id1">9.3.1. 芯片参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/3a6000.html#id2">9.3.2. 芯片架构</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform/2k3000.html">9.4. 2k3000芯片</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k3000.html#id1">9.4.1. 芯片参数</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform/2k1000la.html">9.5. 2k1000LA芯片</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k1000la.html#id1">9.5.1. 芯片参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k1000la.html#id2">9.5.2. 芯片架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k1000la.html#id3">9.5.3. 芯片功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k1000la.html#id4">9.5.4. 地址空间</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform/2k0500.html">9.6. 2k0500芯片</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0500.html#id1">9.6.1. 芯片架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0500.html#id2">9.6.2. 芯片架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0500.html#id3">9.6.3. 芯片架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0500.html#id4">9.6.4. 芯片功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0500.html#id5">9.6.5. 地址空间</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0500.html#id6">9.6.6. 中断配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../platform/2k0300.html">9.7. 2k0300芯片</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0300.html#id1">9.7.1. 芯片参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0300.html#id2">9.7.2. 芯片架构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0300.html#id3">9.7.3. 芯片功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0300.html#id4">9.7.4. 地址空间</a></li>
<li class="toctree-l3"><a class="reference internal" href="../platform/2k0300.html#id5">9.7.5. 中断配置及路由</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../simd/index.html">10. 高级应用：SMID与向量指令</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../simd/todo.html">10.1. TODO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">11. 高级应用：LVZ与虚拟化扩展</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../virt/todo.html">11.1. TODO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">12. FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/faq-25.html">12.1. FAQ-25</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">龙芯实验室文档</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">5. </span>中断与异常系统</a></li>
      <li class="breadcrumb-item active"><span class="section-number">5.3. </span>Kernel与异常</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kernel">
<h1><span class="section-number">5.3. </span>Kernel与异常<a class="headerlink" href="#kernel" title="Link to this heading"></a></h1>
<p>这里所说的异常是指包括了中断和例外，在需要区分处会特别的说明，其他情况都按照异常来说。</p>
<section id="expection-entry-selection">
<span id="id1"></span><h2><span class="section-number">5.3.1. </span>异常的入口地址选择<a class="headerlink" href="#expection-entry-selection" title="Link to this heading"></a></h2>
<p>LoongArch的异常配置比较灵活，可满足不同的使用场景。全局的中断使能我们上节已经说明，除此之外，我们
需要明确异常的处理入口。LoongArch通过配置CSR.ECFG.VS位，来决定处理的入口偏移问题。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>CSR.ECFG.VS：配置例外和中断入口的间距。</p>
<ul class="simple">
<li><p>当 VS =0 时，所有例外和中断的入口地址是同一个。</p></li>
<li><p>当 VS!=0 时，各例外和中断之间的入口地址间距是 2<sup>VS</sup> 条指令。</p></li>
</ul>
<p><strong>TLB重填例外</strong>和<strong>机器错误</strong>例外有<strong>独立的入口基址</strong>，所以二者的例外入口不受 VS域的影响。</p>
</div>
<p>下面我们详细的说明我们常见的两种方式。</p>
<section id="id2">
<h3><span class="section-number">5.3.1.1. </span>“统一式”的入口地址<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p>“统一式”指所有的异常和中断都是使用同一个入口地址，也就是来自CSR.EENTRY寄存器。此时需要配置
<code class="docutils literal notranslate"><span class="pre">CSR.ECFG.VS</span> <span class="pre">=</span> <span class="pre">0</span></code>。</p>
<p>如何区分中断和异常：</p>
<ul class="simple">
<li><p>中断：
此时读取 CSR.ESTAT.Ecode域，如果<code class="docutils literal notranslate"><span class="pre">Ecode</span> <span class="pre">=</span> <span class="pre">0</span></code> 则表明是处于中断。<br />
再读取CSR.ESTAT.IS[12:0]，如IS[12:0]！=0，则对应的位有了中断，然后再具体的处理对应中断。</p></li>
<li><p>异常：
读取 CSR.ESTAT.Ecode域，如果<code class="docutils literal notranslate"><span class="pre">Ecode</span> <span class="pre">!=</span> <span class="pre">0</span></code> 则表明是处于异常，<br />
此时可根据下面的例外代码确认具体的异常类型。</p></li>
</ul>
<table border="1" class="docutils">
<thead>
<tr>
<th>Ecode</th>
<th>EsubCode</th>
<th>例外代号</th>
<th>例外类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x1</td>
<td></td>
<td>PIL</td>
<td>load 操作页无效例外</td>
</tr>
<tr>
<td>0x2</td>
<td></td>
<td>PIS</td>
<td>store 操作页无效例外</td>
</tr>
<tr>
<td>0x3</td>
<td></td>
<td>PIF</td>
<td>取指操作页无效例外</td>
</tr>
<tr>
<td>0x4</td>
<td></td>
<td>PME</td>
<td>页修改例外</td>
</tr>
<tr>
<td>0x5</td>
<td></td>
<td>PNR</td>
<td>页不可读例外</td>
</tr>
<tr>
<td>0x6</td>
<td></td>
<td>PNX</td>
<td>页不可执行例外</td>
</tr>
<tr>
<td>0x7</td>
<td></td>
<td>PPI</td>
<td>页特权等级不合规例外</td>
</tr>
<tr>
<td>0x8</td>
<td>0</td>
<td>ADEF</td>
<td>取指地址错例外</td>
</tr>
<tr>
<td>0x8</td>
<td>1</td>
<td>ADEM</td>
<td>访存指令地址错例外</td>
</tr>
<tr>
<td>0x9</td>
<td></td>
<td>ALE</td>
<td>地址非对齐例外</td>
</tr>
<tr>
<td>0xA</td>
<td></td>
<td>BCE</td>
<td>边界检查错例外</td>
</tr>
<tr>
<td>0xB</td>
<td></td>
<td>SYS</td>
<td>系统调用例外</td>
</tr>
<tr>
<td>0xC</td>
<td></td>
<td>BRK</td>
<td>断点例外</td>
</tr>
<tr>
<td>0xD</td>
<td></td>
<td>INE</td>
<td>指令不存在例外</td>
</tr>
<tr>
<td>0xE</td>
<td></td>
<td>IPE</td>
<td>指令特权等级错例外</td>
</tr>
<tr>
<td>0xF</td>
<td></td>
<td>FPD</td>
<td>浮点指令未使能例外</td>
</tr>
<tr>
<td>0x10</td>
<td></td>
<td>SXD</td>
<td>128 位向量扩展指令未使能例外</td>
</tr>
<tr>
<td>0x11</td>
<td></td>
<td>ASXD</td>
<td>256 位向量扩展指令未使能例外</td>
</tr>
<tr>
<td>0x12</td>
<td>0</td>
<td>FPE</td>
<td>基础浮点指令例外</td>
</tr>
<tr>
<td>0x12</td>
<td>1</td>
<td>VFPE</td>
<td>向量浮点指令例外</td>
</tr>
<tr>
<td>0x13</td>
<td>0</td>
<td>WPEF</td>
<td>取指监测点例外</td>
</tr>
<tr>
<td>0x13</td>
<td>1</td>
<td>WPEM</td>
<td>load/store 操作监测点例外</td>
</tr>
<tr>
<td>0x14</td>
<td></td>
<td>BTD</td>
<td>二进制翻译扩展指令未使能例外</td>
</tr>
<tr>
<td>0x15</td>
<td></td>
<td>BTE</td>
<td>二进制翻译相关例外</td>
</tr>
<tr>
<td>0x16</td>
<td></td>
<td>GSPR</td>
<td>客户机敏感特权资源例外</td>
</tr>
<tr>
<td>0x17</td>
<td></td>
<td>HVC</td>
<td>虚拟机监控调用例外</td>
</tr>
<tr>
<td>0x18</td>
<td>0</td>
<td>GCSC</td>
<td>客户机 CSR 软件修改例外</td>
</tr>
<tr>
<td>0x18</td>
<td>1</td>
<td>GCHC</td>
<td>客户机 CSR 硬件修改例外</td>
</tr>
<tr>
<td>0x1A-0x3E</td>
<td></td>
<td></td>
<td>保留编码</td>
</tr>
</tbody>
</table>
<div class="admonition caution">
<p class="admonition-title">小心</p>
<p>统一式异常和中断入口都来自于CSR.EENTRY，因此需要处理程序判断是来自于中断，还是来自于异常。</p>
<p>如果来自中断，则判断Ecode=0，再跳转到中断处理程序。</p>
<p>如果来自异常，则判断Ecode！=0，具体再判断Ecode和EsubCode确定是那个异常，然后再通过<br />
异常表，跳转到各自异常的执行程序中去处理！</p>
</div>
<p>统一式异常和中断入口处理起来比较简单，但是对于所有的中断和异常都进入一个入口，因此需要花费
指令判断异常类型。因此中断和异常处理程序比较烦躁，要进行各自判断。</p>
</section>
<section id="id3">
<h3><span class="section-number">5.3.1.2. </span>“分离式”的入口地址<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>“分离式”指所有的异常和中断都有各自的入口地址，入口的基址来自CSR.EENTRY寄存器。</p>
<p><code class="docutils literal notranslate"><span class="pre">计算方式为：</span> <span class="pre">入口地址</span> <span class="pre">=</span> <span class="pre">CSR.EENTRY</span> <span class="pre">+</span> <span class="pre">页内偏移</span></code></p>
<p>此时需要配置<code class="docutils literal notranslate"><span class="pre">CSR.ECFG.VS</span> <span class="pre">!=</span> <span class="pre">0</span></code>。</p>
<p>此时异常和中断的入口地址如下所示：</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>入口地址 = CSR.EENTRY + ecode * 2<sup>CSR.ECFG.VS+2</sup></p>
<p>各例外和中断之间的<strong>入口地址间距是 2<sup>VS</sup> 条指令</strong>。</p>
<p>VS配置的大小，具体看Kernel设计的情况。比如，Linux中，将VS=7；而有些嵌入式则设置为1，此时入口间距是2条指令。</p>
</div>
<p>注意：</p>
<p><strong>异常Ecode的值</strong>按照下面的方式计算:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Ecode</th>
<th>EsubCode</th>
<th>例外代号</th>
<th>例外类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x1</td>
<td></td>
<td>PIL</td>
<td>load 操作页无效例外</td>
</tr>
<tr>
<td>0x2</td>
<td></td>
<td>PIS</td>
<td>store 操作页无效例外</td>
</tr>
<tr>
<td>0x3</td>
<td></td>
<td>PIF</td>
<td>取指操作页无效例外</td>
</tr>
<tr>
<td>0x4</td>
<td></td>
<td>PME</td>
<td>页修改例外</td>
</tr>
<tr>
<td>0x5</td>
<td></td>
<td>PNR</td>
<td>页不可读例外</td>
</tr>
<tr>
<td>0x6</td>
<td></td>
<td>PNX</td>
<td>页不可执行例外</td>
</tr>
<tr>
<td>0x7</td>
<td></td>
<td>PPI</td>
<td>页特权等级不合规例外</td>
</tr>
<tr>
<td>0x8</td>
<td>0</td>
<td>ADEF</td>
<td>取指地址错例外</td>
</tr>
<tr>
<td>0x8</td>
<td>1</td>
<td>ADEM</td>
<td>访存指令地址错例外</td>
</tr>
<tr>
<td>0x9</td>
<td></td>
<td>ALE</td>
<td>地址非对齐例外</td>
</tr>
<tr>
<td>0xA</td>
<td></td>
<td>BCE</td>
<td>边界检查错例外</td>
</tr>
<tr>
<td>0xB</td>
<td></td>
<td>SYS</td>
<td>系统调用例外</td>
</tr>
<tr>
<td>0xC</td>
<td></td>
<td>BRK</td>
<td>断点例外</td>
</tr>
<tr>
<td>0xD</td>
<td></td>
<td>INE</td>
<td>指令不存在例外</td>
</tr>
<tr>
<td>0xE</td>
<td></td>
<td>IPE</td>
<td>指令特权等级错例外</td>
</tr>
<tr>
<td>0xF</td>
<td></td>
<td>FPD</td>
<td>浮点指令未使能例外</td>
</tr>
<tr>
<td>0x10</td>
<td></td>
<td>SXD</td>
<td>128 位向量扩展指令未使能例外</td>
</tr>
<tr>
<td>0x11</td>
<td></td>
<td>ASXD</td>
<td>256 位向量扩展指令未使能例外</td>
</tr>
<tr>
<td>0x12</td>
<td>0</td>
<td>FPE</td>
<td>基础浮点指令例外</td>
</tr>
<tr>
<td>0x12</td>
<td>1</td>
<td>VFPE</td>
<td>向量浮点指令例外</td>
</tr>
<tr>
<td>0x13</td>
<td>0</td>
<td>WPEF</td>
<td>取指监测点例外</td>
</tr>
<tr>
<td>0x13</td>
<td>1</td>
<td>WPEM</td>
<td>load/store 操作监测点例外</td>
</tr>
<tr>
<td>0x14</td>
<td></td>
<td>BTD</td>
<td>二进制翻译扩展指令未使能例外</td>
</tr>
<tr>
<td>0x15</td>
<td></td>
<td>BTE</td>
<td>二进制翻译相关例外</td>
</tr>
<tr>
<td>0x16</td>
<td></td>
<td>GSPR</td>
<td>客户机敏感特权资源例外</td>
</tr>
<tr>
<td>0x17</td>
<td></td>
<td>HVC</td>
<td>虚拟机监控调用例外</td>
</tr>
<tr>
<td>0x18</td>
<td>0</td>
<td>GCSC</td>
<td>客户机 CSR 软件修改例外</td>
</tr>
<tr>
<td>0x18</td>
<td>1</td>
<td>GCHC</td>
<td>客户机 CSR 硬件修改例外</td>
</tr>
<tr>
<td>0x1A-0x3E</td>
<td></td>
<td></td>
<td>保留编码</td>
</tr>
</tbody>
</table>
<hr class="docutils" />
<p><strong>中断Ecode的值</strong>按照下面的方式计算:</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Ecode(十六进制)</th>
<th>Ecode(十进制)</th>
<th>例外代号</th>
<th>例外类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x40</td>
<td>64</td>
<td>INT_SWI0</td>
<td>SWI0对应的中断（ESTAT.IS[0]）</td>
</tr>
<tr>
<td>0x41</td>
<td>65</td>
<td>INT_SWI1</td>
<td>SWI1对应的中断（ESTAT.IS[1]）</td>
</tr>
<tr>
<td>0x42</td>
<td>66</td>
<td>INT_HWI0</td>
<td>HWI0对应的中断（ESTAT.IS[2]）</td>
</tr>
<tr>
<td>0x43</td>
<td>67</td>
<td>INT_HWI1</td>
<td>HWI1对应的中断（ESTAT.IS[3]）</td>
</tr>
<tr>
<td>0x44</td>
<td>68</td>
<td>INT_HWI2</td>
<td>HWI2对应的中断（ESTAT.IS[4]）</td>
</tr>
<tr>
<td>0x45</td>
<td>69</td>
<td>INT_HWI3</td>
<td>HWI3对应的中断（ESTAT.IS[5]）</td>
</tr>
<tr>
<td>0x46</td>
<td>70</td>
<td>INT_HWI4</td>
<td>HWI4对应的中断（ESTAT.IS[6]）</td>
</tr>
<tr>
<td>0x47</td>
<td>71</td>
<td>INT_HWI5</td>
<td>HWI5对应的中断（ESTAT.IS[7]）</td>
</tr>
<tr>
<td>0x48</td>
<td>72</td>
<td>INT_HWI6</td>
<td>HWI6对应的中断（ESTAT.IS[8]）</td>
</tr>
<tr>
<td>0x49</td>
<td>73</td>
<td>INT_HWI7</td>
<td>HWI7对应的中断（ESTAT.IS[9]）</td>
</tr>
<tr>
<td>0x4A</td>
<td>74</td>
<td>INT_PMI</td>
<td>性能计数器中断（ESTAT.IS[10]）</td>
</tr>
<tr>
<td>0x4B</td>
<td>75</td>
<td>INT_TI</td>
<td>Timer中断 （ESTAT.IS[11]）</td>
</tr>
<tr>
<td>0x4C</td>
<td>76</td>
<td>INT_IPI</td>
<td>核间中断   （ESTAT.IS[12]）</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="id4">
<h2><span class="section-number">5.3.2. </span>异常的初始化<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<p>这里我们讨论上述两种方式的初始化，以及需要主要的事项。</p>
<p>不管是分离式还是同一的方式，中断的全局使能(CSR.CRMD.IE)、局部(CSR.ECFG.LIE)都是一样的，<br />
他们只是入口地址不一样而已，其他都是相同的！</p>
<p>下面我们以例子列举初始化的过程，以及需要注意的！</p>
<section id="id5">
<h3><span class="section-number">5.3.2.1. </span>统一式的初始化<a class="headerlink" href="#id5" title="Link to this heading"></a></h3>
<p>初始化流程如下：</p>
<ul>
<li><p>设置异常处理通用代码，主要是按照上面的说明，区分中断和异常，分别处理。</p></li>
<li><p>配置<code class="docutils literal notranslate"><span class="pre">CSR.ECFG.VS</span> <span class="pre">=</span> <span class="pre">0</span></code>，表示使用统一式的中断处理。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">CSR.ECFG.VS</span></code>默认为0，也可以不用配置，表示使用同一的入口。</p>
</div>
</li>
<li><p>配置中断的相应的局部使能位：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CSR.ECFG.LIE[12:0]对应于CSR.ESTAT.IS[12:0]，如果想要使能哪一位中断源，则将其对应的LIE[x]位置1。
</pre></div>
</div>
</li>
<li><p>将异常处理程序的地址写入CSR.EENTRY。发生异常时，从这里开始执行。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>CSR.EENTRY写入的时候，<strong>必须按照4K页对齐</strong>，也就是说，异常处理程序必须4K页对齐！</p>
</div>
</li>
<li><p>通过写CSR.CRMD.IE来控制全局的中断使能。</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p><strong>例外没有使能位控制位</strong>，如果发生则会执行相应的代码！</p>
</div>
<section id="id6">
<h4><span class="section-number">5.3.2.1.1. </span>异常处理程序的例子<a class="headerlink" href="#id6" title="Link to this heading"></a></h4>
<p>下面是一个内核的异常处理过程。</p>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="c1">// 将所有寄存器的值恢复（除SP寄存器指针）</span>
<span class="na">.macro</span><span class="w"> </span><span class="no">POP_GENERAL_REGS</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$ra</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">1</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$tp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">2</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">4</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">5</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">6</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">7</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">8</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">9</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">10</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$a7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">11</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">12</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">13</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">14</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">15</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">16</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">17</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">18</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">19</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$t8</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">20</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$r21</span><span class="p">,</span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">21</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$fp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">22</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">23</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">24</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">25</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">26</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">27</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">28</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">29</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">30</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">   </span><span class="no">$s8</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">31</span>
<span class="na">.endm</span>

<span class="c1">// 将所有寄存器的值保存（除SP寄存器指针）</span>
<span class="na">.macro</span><span class="w"> </span><span class="no">PUSH_GENERAL_REGS</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$ra</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">1</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$tp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">2</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">4</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">5</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">6</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">7</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">8</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">9</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">10</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$a7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">11</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">12</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">13</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">14</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">15</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">16</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">17</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">18</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">19</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$t8</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">20</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$r21</span><span class="p">,</span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">21</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$fp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">22</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">23</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">24</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">25</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">26</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">27</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">28</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">29</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">30</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">   </span><span class="no">$s8</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">*</span><span class="mi">31</span>
<span class="na">.endm</span>
</pre></div>
</div>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="na">.section</span><span class="w"> </span><span class="no">.text</span>
<span class="na">.balign</span><span class="w"> </span><span class="mi">4096</span>
<span class="na">.global</span><span class="w"> </span><span class="no">exception_entry_base</span>
<span class="nl">exception_entry_base:</span>
<span class="w">    </span><span class="nf">csrwr</span><span class="w">   </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">KSAVE_KSP</span>
<span class="w">    </span><span class="nf">bnez</span><span class="w">    </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">.Ltrap_entry</span>

<span class="w">    </span><span class="nf">csrrd</span><span class="w">   </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">KSAVE_KSP</span>
<span class="w">    </span><span class="nf">addi.d</span><span class="w">  </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="p">-{</span><span class="no">trapframe_size</span><span class="p">}</span>

<span class="nl">.Ltrap_entry:</span>
<span class="w">    </span><span class="nf">PUSH_GENERAL_REGS</span>

<span class="w">    </span><span class="nf">csrrd</span><span class="w">   </span><span class="no">$t0</span><span class="p">,</span><span class="w"> </span><span class="no">KSAVE_KSP</span>
<span class="w">    </span><span class="nf">csrwr</span><span class="w">   </span><span class="no">$r0</span><span class="p">,</span><span class="w"> </span><span class="no">KSAVE_KSP</span>
<span class="w">    </span><span class="nf">csrrd</span><span class="w">   </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">LA_CSR_PRMD</span>
<span class="w">    </span><span class="nf">csrrd</span><span class="w">   </span><span class="no">$t2</span><span class="p">,</span><span class="w"> </span><span class="no">LA_CSR_ERA</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$t0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">    </span><span class="c1">// prmd</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$t2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="w">    </span><span class="c1">// era</span>

<span class="w">    </span><span class="nf">move</span><span class="w">    </span><span class="no">$a0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span>

<span class="w">    </span><span class="nf">andi</span><span class="w">    </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="mi">0x3</span>
<span class="w">    </span><span class="nf">bnez</span><span class="w">    </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">.Lexit_user</span>

<span class="w">    </span><span class="nf">la.abs</span><span class="w">  </span><span class="no">$ra</span><span class="p">,</span><span class="w"> </span><span class="no">.Ltrap_return</span>
<span class="w">    </span><span class="nf">b</span><span class="w">       </span><span class="no">loongarch64_trap_handler</span>

<span class="nl">.Lexit_user:</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">$a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$r0</span><span class="p">,</span><span class="w"> </span><span class="no">$a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$ra</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$tp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$fp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$r21</span><span class="p">,</span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$s8</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span>

<span class="w">    </span><span class="nf">addi.d</span><span class="w">  </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">ret</span>

<span class="na">.global</span><span class="w"> </span><span class="no">enter_user</span>
<span class="nl">enter_user:</span>
<span class="w">    </span><span class="nf">addi.d</span><span class="w">  </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-14</span><span class="w"> </span><span class="p">*</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$ra</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$tp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$fp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$r21</span><span class="p">,</span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s2</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s3</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s4</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s5</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s6</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s7</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span>
<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$s8</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span>

<span class="w">    </span><span class="nf">st.d</span><span class="w">    </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">$a0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">move</span><span class="w">    </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">$a0</span>
<span class="w">    </span><span class="nf">csrwr</span><span class="w">   </span><span class="no">$a0</span><span class="p">,</span><span class="w"> </span><span class="no">KSAVE_KSP</span>

<span class="nl">.Ltrap_return:</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$t0</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">    </span><span class="c1">// prmd</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="w">    </span><span class="c1">// era</span>
<span class="w">    </span><span class="nf">csrwr</span><span class="w">   </span><span class="no">$t0</span><span class="p">,</span><span class="w"> </span><span class="no">LA_CSR_PRMD</span>
<span class="w">    </span><span class="nf">csrwr</span><span class="w">   </span><span class="no">$t1</span><span class="p">,</span><span class="w"> </span><span class="no">LA_CSR_ERA</span>

<span class="w">    </span><span class="nf">POP_GENERAL_REGS</span>
<span class="w">    </span><span class="nf">ld.d</span><span class="w">    </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="no">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span>

<span class="w">    </span><span class="nf">ertn</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h3><span class="section-number">5.3.2.2. </span>分离式的初始化<a class="headerlink" href="#id7" title="Link to this heading"></a></h3>
<p>初始化流程如下：</p>
<ul>
<li><p>设置异常处理通用代码，这个时候和统一方式不同的是，每个例外都有各自对应的历程，<br />
而中断则一般使用一个统一的代码处理逻辑。</p>
<p>比如Linux中LoongArch相关的异常例外都是这种方式组织的。</p>
<p>但是也可以写成一个，多个不同的例外都使用同一个也是可以的。</p>
</li>
<li><p>配置<code class="docutils literal notranslate"><span class="pre">CSR.ECFG.VS</span> <span class="pre">！=</span> <span class="pre">0</span></code>，表示使用分离式的中断处理。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">CSR.ECFG.VS</span></code>配置成多少，表示每个例外的可以放2<sup>VS</sup> 条指令</p>
</div>
</li>
<li><p>配置中断的相应的局部使能位：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>CSR.ECFG.LIE[12:0]对应于CSR.ESTAT.IS[12:0]，如果想要使能哪一位中断源，则将其对应的LIE[x]位置1。
</pre></div>
</div>
</li>
<li><p>申请一个4K页对齐的内存空间，我们作为异常的基址EVaddr。</p></li>
<li><p>将上面申请的EVaddr地址写入CSR.EENTRY。发生异常时，用于参与计算入口地址。计算方法按照</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>入口地址 = CSR.EENTRY + ecode * 2<sup>CSR.ECFG.VS+2</sup></p>
</div>
</li>
<li><p>将我们的<strong>例外的处理函数以及中断的处理函数指令片段</strong>，复制到以EVaddr为Base地址相应的入口处。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>拷贝指令时，不能超过2<sup>VS+2</sup>个字节，如果超过有可能操作例外程序的覆盖，因此在<br />
组织汇编代码的历程时，一定要控制代码指令条数。可以使用绝对跳转指令<code class="docutils literal notranslate"><span class="pre">la.abs</span>&#160; <span class="pre">sym</span></code><br />
这种方式来处理。</p>
</div>
</li>
<li><p>通过写CSR.CRMD.IE来控制全局的中断使能。</p></li>
</ul>
<section id="id8">
<h4><span class="section-number">5.3.2.2.1. </span>异常处理程序的例子<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p>下面是一个Linux内核的异常处理过程。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SYM_CODE_START</span><span class="p">(</span><span class="n">handle_vint</span><span class="p">)</span>
	<span class="n">UNWIND_HINT_UNDEFINED</span>
	<span class="n">BACKUP_T0T1</span>
	<span class="n">SAVE_ALL</span>
	<span class="n">la_abs</span>	<span class="n">t1</span><span class="p">,</span> <span class="n">__arch_cpu_idle</span>
	<span class="n">LONG_L</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_ERA</span>
	<span class="o">/*</span> <span class="mi">32</span> <span class="n">byte</span> <span class="n">rollback</span> <span class="n">region</span> <span class="o">*/</span>
	<span class="n">ori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="mh">0x1f</span>
	<span class="n">xori</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="mh">0x1f</span>
	<span class="n">bne</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="n">f</span>
	<span class="n">LONG_S</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_ERA</span>
<span class="mi">1</span><span class="p">:</span>	<span class="n">move</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">sp</span>
	<span class="n">move</span>	<span class="n">a1</span><span class="p">,</span> <span class="n">sp</span>
	<span class="n">la_abs</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">do_vint</span>
	<span class="n">jirl</span>	<span class="n">ra</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="n">RESTORE_ALL_AND_RET</span>
<span class="n">SYM_CODE_END</span><span class="p">(</span><span class="n">handle_vint</span><span class="p">)</span>
</pre></div>
</div>
<p>处理中断的函数是do_vint，具体如下：</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">asmlinkage</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">noinstr</span><span class="w"> </span><span class="n">do_vint</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">pt_regs</span><span class="w"> </span><span class="o">*</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">;</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">stack</span><span class="p">;</span>
<span class="w">	</span><span class="n">irqentry_state_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">irqentry_enter</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

<span class="w">	</span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smp_processor_id</span><span class="p">();</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on_irq_stack</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">))</span>
<span class="w">		</span><span class="n">handle_loongarch_irq</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">per_cpu</span><span class="p">(</span><span class="n">irq_stack</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">IRQ_STACK_START</span><span class="p">;</span>

<span class="w">		</span><span class="cm">/* Save task&#39;s sp on IRQ stack for unwinding */</span>
<span class="w">		</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">;</span>

<span class="w">		</span><span class="n">__asm__</span><span class="w"> </span><span class="n">__volatile__</span><span class="p">(</span>
<span class="w">		</span><span class="s">&quot;move	$s0, $sp		</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="cm">/* Preserve sp */</span>
<span class="w">		</span><span class="s">&quot;move	$sp, %[stk]		</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="cm">/* Switch stack */</span>
<span class="w">		</span><span class="s">&quot;move	$a0, %[regs]		</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">		</span><span class="s">&quot;bl	handle_loongarch_irq	</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">		</span><span class="s">&quot;move	$sp, $s0		</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="cm">/* Restore sp */</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="cm">/* No outputs */</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="n">stk</span><span class="p">]</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">stack</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">regs</span><span class="p">]</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">regs</span><span class="p">)</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;$a0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$a1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$a2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$a3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$a4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$a5&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$a6&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$a7&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$s0&quot;</span><span class="p">,</span>
<span class="w">		  </span><span class="s">&quot;$t0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t5&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t6&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t7&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;$t8&quot;</span><span class="p">,</span>
<span class="w">		  </span><span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="n">irqentry_exit</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<hr class="docutils" />
<p>下面这是处理其他异常，比如ADE, ALE, BP, FPE, FPU, LSX等异常的流程。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">macro</span>	<span class="n">BUILD_HANDLER</span> <span class="n">exception</span> <span class="n">handler</span> <span class="n">prep</span>
<span class="o">.</span><span class="n">align</span>	<span class="mi">5</span>
	<span class="n">SYM_CODE_START</span><span class="p">(</span><span class="n">handle_</span>\<span class="n">exception</span><span class="p">)</span>
	<span class="n">UNWIND_HINT_UNDEFINED</span>
<span class="mi">666</span><span class="p">:</span>
	<span class="n">BACKUP_T0T1</span>
	<span class="n">SAVE_ALL</span>
	<span class="n">build_prep_</span>\<span class="n">prep</span>
	<span class="n">move</span>	<span class="n">a0</span><span class="p">,</span> <span class="n">sp</span>
	<span class="n">la_abs</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">do_</span>\<span class="n">handler</span>
	<span class="n">jirl</span>	<span class="n">ra</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="mi">0</span>
<span class="mi">668</span><span class="p">:</span>
	<span class="n">RESTORE_ALL_AND_RET</span>
	<span class="n">SYM_CODE_END</span><span class="p">(</span><span class="n">handle_</span>\<span class="n">exception</span><span class="p">)</span>
<span class="o">.</span><span class="n">pushsection</span>	<span class="s2">&quot;.data&quot;</span><span class="p">,</span> <span class="s2">&quot;aw&quot;</span><span class="p">,</span> <span class="o">%</span><span class="n">progbits</span>
	<span class="n">SYM_DATA</span><span class="p">(</span><span class="n">unwind_hint_</span>\<span class="n">exception</span><span class="p">,</span> <span class="o">.</span><span class="n">word</span> <span class="mi">668</span><span class="n">b</span> <span class="o">-</span> <span class="mi">666</span><span class="n">b</span><span class="p">)</span>
<span class="o">.</span><span class="n">popsection</span>
<span class="o">.</span><span class="n">endm</span>

	<span class="n">BUILD_HANDLER</span> <span class="n">ade</span> <span class="n">ade</span> <span class="n">badv</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">ale</span> <span class="n">ale</span> <span class="n">badv</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">bce</span> <span class="n">bce</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">bp</span> <span class="n">bp</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">fpe</span> <span class="n">fpe</span> <span class="n">fcsr</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">fpu</span> <span class="n">fpu</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">lsx</span> <span class="n">lsx</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">lasx</span> <span class="n">lasx</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">lbt</span> <span class="n">lbt</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">ri</span> <span class="n">ri</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">watch</span> <span class="n">watch</span> <span class="n">none</span>
	<span class="n">BUILD_HANDLER</span> <span class="n">reserved</span> <span class="n">reserved</span> <span class="n">none</span>	<span class="o">/*</span> <span class="n">others</span> <span class="o">*/</span>
</pre></div>
</div>
<hr class="docutils" />
<p>下面代码段时，Linux中将各个例外处理函数的拷贝过程。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cp">#define VECSIZE 0x200</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup_vint_size</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">vs</span><span class="p">;</span>

<span class="w">	</span><span class="n">vs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilog2</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span>
<span class="w">		</span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;vint_size %d Not support yet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vs</span><span class="p">);</span>

<span class="w">	</span><span class="n">csr_xchg32</span><span class="p">(</span><span class="n">vs</span><span class="o">&lt;&lt;</span><span class="n">CSR_ECFG_VS_SHIFT</span><span class="p">,</span><span class="w"> </span><span class="n">CSR_ECFG_VS</span><span class="p">,</span><span class="w"> </span><span class="n">LOONGARCH_CSR_ECFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">per_cpu_trap_init</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">	</span><span class="c1">// ......</span>
<span class="w">	</span><span class="n">setup_vint_size</span><span class="p">(</span><span class="n">VECSIZE</span><span class="p">);</span>

<span class="w">	</span><span class="n">configure_exception_vector</span><span class="p">();</span>
<span class="w">	</span><span class="c1">// ......</span>
<span class="p">}</span>

<span class="cm">/* Install CPU exception handler */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">set_handler</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">eentry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">),</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">	</span><span class="n">local_flush_icache_range</span><span class="p">(</span><span class="n">eentry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">eentry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/* Interrupt numbers */</span>
<span class="cp">#define INT_SWI0	0	</span><span class="cm">/* Software Interrupts */</span>
<span class="cp">#define INT_SWI1	1</span>
<span class="cp">#define INT_HWI0	2	</span><span class="cm">/* Hardware Interrupts */</span>
<span class="cp">#define INT_HWI1	3</span>
<span class="cp">#define INT_HWI2	4</span>
<span class="cp">#define INT_HWI3	5</span>
<span class="cp">#define INT_HWI4	6</span>
<span class="cp">#define INT_HWI5	7</span>
<span class="cp">#define INT_HWI6	8</span>
<span class="cp">#define INT_HWI7	9</span>
<span class="cp">#define INT_PCOV	10	</span><span class="cm">/* Performance Counter Overflow */</span>
<span class="cp">#define INT_TI		11	</span><span class="cm">/* Timer */</span>
<span class="cp">#define INT_IPI		12</span>
<span class="cp">#define INT_NMI		13</span>
<span class="cp">#define INT_AVEC	14</span>

<span class="cm">/* ExcCodes corresponding to interrupts */</span>
<span class="cp">#define EXCCODE_INT_NUM		(INT_AVEC + 1)</span>
<span class="cp">#define EXCCODE_INT_START	64</span>
<span class="cp">#define EXCCODE_INT_END		(EXCCODE_INT_START + EXCCODE_INT_NUM - 1)</span>

<span class="kt">void</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">	</span><span class="cm">/* Set interrupt vector handler */</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXCCODE_INT_START</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">EXCCODE_INT_END</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">		</span><span class="n">set_handler</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">VECSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">handle_vint</span><span class="p">,</span><span class="w"> </span><span class="n">VECSIZE</span><span class="p">);</span>

<span class="w">	</span><span class="cm">/* Set exception vector handler */</span>
<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXCCODE_ADE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">EXCCODE_BTDIS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">		</span><span class="n">set_handler</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">VECSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">exception_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">VECSIZE</span><span class="p">);</span>

<span class="w">	</span><span class="n">cache_error_setup</span><span class="p">();</span>

<span class="w">	</span><span class="n">local_flush_icache_range</span><span class="p">(</span><span class="n">eentry</span><span class="p">,</span><span class="w"> </span><span class="n">eentry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x400</span><span class="p">);</span>
<span class="p">}</span>

</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">eentry</span><span class="p">;</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">tlbrentry</span><span class="p">;</span>

<span class="kt">long</span><span class="w"> </span><span class="n">exception_handlers</span><span class="p">[</span><span class="n">VECSIZE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">128</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)]</span><span class="w"> </span><span class="n">__aligned</span><span class="p">(</span><span class="n">SZ_64K</span><span class="p">);</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure_exception_vector</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="n">eentry</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">exception_handlers</span><span class="p">;</span>
<span class="w">	</span><span class="n">tlbrentry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">exception_handlers</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">80</span><span class="o">*</span><span class="n">VECSIZE</span><span class="p">;</span>

<span class="w">	</span><span class="n">csr_write64</span><span class="p">(</span><span class="n">eentry</span><span class="p">,</span><span class="w"> </span><span class="n">LOONGARCH_CSR_EENTRY</span><span class="p">);</span>
<span class="w">	</span><span class="n">csr_write64</span><span class="p">(</span><span class="n">eentry</span><span class="p">,</span><span class="w"> </span><span class="n">LOONGARCH_CSR_MERRENTRY</span><span class="p">);</span>
<span class="w">	</span><span class="n">csr_write64</span><span class="p">(</span><span class="n">tlbrentry</span><span class="p">,</span><span class="w"> </span><span class="n">LOONGARCH_CSR_TLBRENTRY</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>TLB相关的处理历程也是在函数<code class="docutils literal notranslate"><span class="pre">setup_tlb_handler</span></code>中拷贝到了目的入口处。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup_tlb_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="cm">/* The tlb handlers are generated only once */</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">tlbrentry</span><span class="p">,</span><span class="w"> </span><span class="n">handle_tlb_refill</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span>
<span class="w">		</span><span class="n">local_flush_icache_range</span><span class="p">(</span><span class="n">tlbrentry</span><span class="p">,</span><span class="w"> </span><span class="n">tlbrentry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x80</span><span class="p">);</span>

<span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXCCODE_TLBL</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">EXCCODE_TLBPE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">			</span><span class="n">set_handler</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">VECSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">exception_table</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">VECSIZE</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>上述代码的eentry是分配的4KB对齐的内存空间，在<code class="docutils literal notranslate"><span class="pre">trap_init</span></code>初始化的时候，将各自的
处理代码通过函数<code class="docutils literal notranslate"><span class="pre">set_handler</span></code>复制到了各自的入口处。</p>
</section>
</section>
</section>
<section id="cpu">
<h2><span class="section-number">5.3.3. </span>异常发生时，CPU做了什么<a class="headerlink" href="#cpu" title="Link to this heading"></a></h2>
<p>当触发普通例外时，处理器硬件会进行如下操作：</p>
<ul class="simple">
<li><p>❖ 将 CSR.CRMD 的 PLV、IE 分别存到 CSR.PRMD 的 PPLV、PIE 中，然后将 CSR.CRMD 的 PLV 置<br />
为 0，IE 置为 0；</p></li>
<li><p>❖ 对于支持 Watch 功能的实现，还要将 CSR.CRMD 的 WE 存到 CSR.PRMD 的 PWE 中，然后将<br />
CSR.CRMD 的 WE 置为 0；</p></li>
<li><p>❖ 将触发例外指令的 PC 值记录到 CSR.ERA 中；</p></li>
<li><p>❖ 跳转到例外入口处取指。<br />
当软件执行 ERTN 指令从普通例外执行返回时，处理器硬件会完成如下操作：</p></li>
<li><p>❖ 将 CSR.PRMD 中的 PPLV、PIE 值恢复到 CSR.CRMD 的 PLV、IE 中；</p></li>
<li><p>❖ 对于支持 Watch 功能的实现，还要将 CSR.PRMD 中的 PWE 值恢复到 CSR.CRMD 的 WE 中；</p></li>
<li><p>❖ 跳转到 CSR.ERA 所记录的地址处取指。<br />
针对上述硬件实现，软件在例外处理过程的中途如果需要开启中断，需要保存 CSR.PRMD 中的 PPLV、<br />
PIE 等信息，并在例外返回前，将所保存的信息恢复到 CSR.PRMD 中。</p></li>
</ul>
</section>
</section>
<section id="id9">
<h1><span class="section-number">5.4. </span>特殊异常的处理<a class="headerlink" href="#id9" title="Link to this heading"></a></h1>
<p>下面我们详细介绍下，LoongArch上几个特殊的异常或者中断的使用方法。</p>
<section id="id10">
<h2><span class="section-number">5.4.1. </span>定时器中断<a class="headerlink" href="#id10" title="Link to this heading"></a></h2>
<p>LoongArch相关的定时器的状态控制寄存器如下所示：</p>
<p><strong>TID</strong>: 定时器编号</p>
<p>处理器中每个定时器都有一个唯一可识别的编号，由软件配置在该寄存器中。每个定时器也同时唯一<br />
对应着一个计时器，当软件使用 RDTIME 指令读取计时器数值时，一并返回的计时器 ID 号也就是与之对应<br />
的定时器编号。</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>位</th>
<th>名字</th>
<th>读写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>31:0</td>
<td>TID</td>
<td>RW</td>
<td>定时器编号。软件可配置。处理器核复位期间，硬件可以将其复位成与 CSR.CPUID 中<br>CoreID 相同的值。</td>
</tr>
</tbody>
</table>
<hr class="docutils" />
<p><strong>TCFG</strong>: 定时器配置</p>
<p>该寄存器是软件配置定时器的接口。定时器的有效位数由实现决定，因此该寄存器中 InitVal 域的位
宽也将随之变化。</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>位</th>
<th>名字</th>
<th>读写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>En</td>
<td>RW</td>
<td>定时器使能位。仅当该位为 1 时，定时器才会进行倒计时自减，并在减为 0 值时置起<br>定时中断信号。</td>
</tr>
<tr>
<td>1</td>
<td>Periodic</td>
<td>RW</td>
<td>定时器循环模式控制位。若该位为 1，定时器在倒计时自减至 0 时，在置起定时中断<br>信号的同时，还会自动定时器重新装载成 InitVal 域中配置的初始值，然后再下一个<br>时钟周期继续自减。若该位为 0，定时器在倒计时自减至 0 时，将停止计数直至软件<br>再次配置该定时器。</td>
</tr>
<tr>
<td>n-1:2</td>
<td>InitVal</td>
<td>RW</td>
<td>定时器倒计时自减计数的初始值。要求该初始值必须是 4 的整倍数。硬件将自动在该<br>域数值的最低位补上两比特 0 后再使用。</td>
</tr>
<tr>
<td>GRLEN-1:n</td>
<td>0</td>
<td>R</td>
<td>只读恒为 0，写被忽略。</td>
</tr>
</tbody>
</table>
<hr class="docutils" />
<p><strong>TVAL</strong>: 定时器数值</p>
<p>软件可通过读取该寄存器来获知定时器当前的计数值。定时器的有效位数由实现决定，因此该寄存器<br />
中 TimeVal 域的位宽也将随之变化</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>位</th>
<th>名字</th>
<th>读写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>n-1:0</td>
<td>TimeVal</td>
<td>R</td>
<td>当前定时器的计数值。</td>
</tr>
<tr>
<td>GRLEN-1:n</td>
<td>0</td>
<td>R</td>
<td>只读恒为 0，写被忽略。</td>
</tr>
</tbody>
</table>
<hr class="docutils" />
<p><strong>CNTC</strong>: 计时器补偿</p>
<p>软件可以通过配置该寄存器来对计时器的读出值进行修正，最终的读出值为：计时器原始计数值+计时<br />
器补偿值。需知配置该寄存器不可直接改变计时器的计数值。</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>位</th>
<th>名字</th>
<th>读写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>GRLEN-1:0</td>
<td>Compensation</td>
<td>RW</td>
<td>软件可配置的计时器补偿值。</td>
</tr>
</tbody>
</table>
<hr class="docutils" />
<p><strong>TICLR</strong>: 定时中断清除</p>
<p>软件通过对该寄存器位 0 写 1 来清除定时器置起的定时中断信号。</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>位</th>
<th>名字</th>
<th>读写</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>CLR</td>
<td>W1</td>
<td>当对该 bit 写值 1 时，将清除时钟中断标记。该寄存器读出结果总为 0。</td>
</tr>
</tbody>
</table>
<hr class="docutils" />
<p>下面是Linux中，定时器的一些处理函数，比如周期的方式，或者oneshot的方式等！</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">irqreturn_t</span><span class="w"> </span><span class="nf">constant_timer_interrupt</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">irq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smp_processor_id</span><span class="p">();</span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="n">cd</span><span class="p">;</span>

<span class="w">	</span><span class="cm">/* Clear Timer Interrupt */</span>
<span class="w">	</span><span class="n">write_csr_tintclear</span><span class="p">(</span><span class="n">CSR_TINTCLR_TI</span><span class="p">);</span>
<span class="w">	</span><span class="n">cd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">constant_clockevent_device</span><span class="p">,</span><span class="w"> </span><span class="n">cpu</span><span class="p">);</span>
<span class="w">	</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">event_handler</span><span class="p">(</span><span class="n">cd</span><span class="p">);</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">constant_set_state_oneshot</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timer_config</span><span class="p">;</span>

<span class="w">	</span><span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_lock</span><span class="p">);</span>

<span class="w">	</span><span class="n">timer_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">csr_read64</span><span class="p">(</span><span class="n">LOONGARCH_CSR_TCFG</span><span class="p">);</span>
<span class="w">	</span><span class="n">timer_config</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">CSR_TCFG_EN</span><span class="p">;</span>
<span class="w">	</span><span class="n">timer_config</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">CSR_TCFG_PERIOD</span><span class="p">;</span>
<span class="w">	</span><span class="n">csr_write64</span><span class="p">(</span><span class="n">timer_config</span><span class="p">,</span><span class="w"> </span><span class="n">LOONGARCH_CSR_TCFG</span><span class="p">);</span>

<span class="w">	</span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_lock</span><span class="p">);</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">constant_set_state_periodic</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">clock_event_device</span><span class="w"> </span><span class="o">*</span><span class="n">evt</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">period</span><span class="p">;</span>
<span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timer_config</span><span class="p">;</span>

<span class="w">	</span><span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_lock</span><span class="p">);</span>

<span class="w">	</span><span class="n">period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">const_clock_freq</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">HZ</span><span class="p">;</span>
<span class="w">	</span><span class="n">timer_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CSR_TCFG_VAL</span><span class="p">;</span>
<span class="w">	</span><span class="n">timer_config</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">CSR_TCFG_PERIOD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CSR_TCFG_EN</span><span class="p">);</span>
<span class="w">	</span><span class="n">csr_write64</span><span class="p">(</span><span class="n">timer_config</span><span class="p">,</span><span class="w"> </span><span class="n">LOONGARCH_CSR_TCFG</span><span class="p">);</span>

<span class="w">	</span><span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_lock</span><span class="p">);</span>

<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>需要注意的是，定时器中断通过向CSR.TICLR寄存器写<code class="docutils literal notranslate"><span class="pre">1</span></code>来清除定时中断信号！</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Clear Timer Interrupt */</span>
<span class="w">	</span><span class="n">write_csr_tintclear</span><span class="p">(</span><span class="n">CSR_TINTCLR_TI</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="id11">
<h2><span class="section-number">5.4.2. </span>系统调用<a class="headerlink" href="#id11" title="Link to this heading"></a></h2>
<p>系统调用（System Call）是用户空间程序与内核空间交互的唯一合法接口，允许应用程序<br />
请求内核执行特权操作（如文件读写、进程控制等）。其核心作用包括：</p>
<ul class="simple">
<li><p>资源访问控制：用户程序无法直接操作硬件或内核数据，需通过系统调用委托内核完成。</p></li>
<li><p>抽象硬件差异：提供统一的接口（如open/read），屏蔽底层设备差异。</p></li>
<li><p>安全隔离：通过权限校验（如UID/GID）防止非法访问。</p></li>
</ul>
<p>LoongArch使用<code class="docutils literal notranslate"><span class="pre">syscall</span> <span class="pre">0</span></code>产生系统调用异常。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SYM_CODE_START</span><span class="p">(</span><span class="n">handle_sys</span><span class="p">)</span>
	<span class="n">UNWIND_HINT_UNDEFINED</span>
	<span class="n">la_abs</span>	<span class="n">t0</span><span class="p">,</span> <span class="n">handle_syscall</span>
	<span class="n">jr</span>	<span class="n">t0</span>
<span class="n">SYM_CODE_END</span><span class="p">(</span><span class="n">handle_sys</span><span class="p">)</span>

</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SYM_CODE_START</span><span class="p">(</span><span class="n">handle_syscall</span><span class="p">)</span>
	<span class="n">UNWIND_HINT_UNDEFINED</span>
	<span class="n">csrrd</span>		<span class="n">t0</span><span class="p">,</span> <span class="n">PERCPU_BASE_KS</span>
	<span class="n">la</span><span class="o">.</span><span class="n">pcrel</span>	<span class="n">t1</span><span class="p">,</span> <span class="n">kernelsp</span>
	<span class="n">add</span><span class="o">.</span><span class="n">d</span>		<span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t0</span>
	<span class="n">move</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">sp</span>
	<span class="n">ld</span><span class="o">.</span><span class="n">d</span>		<span class="n">sp</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">0</span>

	<span class="n">addi</span><span class="o">.</span><span class="n">d</span>		<span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="o">-</span><span class="n">PT_SIZE</span>
	<span class="n">cfi_st</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">PT_R3</span>
	<span class="n">cfi_rel_offset</span>	<span class="n">sp</span><span class="p">,</span> <span class="n">PT_R3</span>
	<span class="n">st</span><span class="o">.</span><span class="n">d</span>		<span class="n">zero</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_R0</span>
	<span class="n">csrrd</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">LOONGARCH_CSR_PRMD</span>
	<span class="n">st</span><span class="o">.</span><span class="n">d</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_PRMD</span>
	<span class="n">csrrd</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">LOONGARCH_CSR_CRMD</span>
	<span class="n">st</span><span class="o">.</span><span class="n">d</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_CRMD</span>
	<span class="n">csrrd</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">LOONGARCH_CSR_EUEN</span>
	<span class="n">st</span><span class="o">.</span><span class="n">d</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_EUEN</span>
	<span class="n">csrrd</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">LOONGARCH_CSR_ECFG</span>
	<span class="n">st</span><span class="o">.</span><span class="n">d</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_ECFG</span>
	<span class="n">csrrd</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">LOONGARCH_CSR_ESTAT</span>
	<span class="n">st</span><span class="o">.</span><span class="n">d</span>		<span class="n">t2</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_ESTAT</span>
	<span class="n">cfi_st</span>		<span class="n">ra</span><span class="p">,</span> <span class="n">PT_R1</span>
	<span class="n">cfi_st</span>		<span class="n">a0</span><span class="p">,</span> <span class="n">PT_R4</span>
	<span class="n">cfi_st</span>		<span class="n">a1</span><span class="p">,</span> <span class="n">PT_R5</span>
	<span class="n">cfi_st</span>		<span class="n">a2</span><span class="p">,</span> <span class="n">PT_R6</span>
	<span class="n">cfi_st</span>		<span class="n">a3</span><span class="p">,</span> <span class="n">PT_R7</span>
	<span class="n">cfi_st</span>		<span class="n">a4</span><span class="p">,</span> <span class="n">PT_R8</span>
	<span class="n">cfi_st</span>		<span class="n">a5</span><span class="p">,</span> <span class="n">PT_R9</span>
	<span class="n">cfi_st</span>		<span class="n">a6</span><span class="p">,</span> <span class="n">PT_R10</span>
	<span class="n">cfi_st</span>		<span class="n">a7</span><span class="p">,</span> <span class="n">PT_R11</span>
	<span class="n">csrrd</span>		<span class="n">ra</span><span class="p">,</span> <span class="n">LOONGARCH_CSR_ERA</span>
	<span class="n">st</span><span class="o">.</span><span class="n">d</span>		<span class="n">ra</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">PT_ERA</span>
	<span class="n">cfi_rel_offset</span>	<span class="n">ra</span><span class="p">,</span> <span class="n">PT_ERA</span>

	<span class="n">cfi_st</span>		<span class="n">tp</span><span class="p">,</span> <span class="n">PT_R2</span>
	<span class="n">cfi_st</span>		<span class="n">u0</span><span class="p">,</span> <span class="n">PT_R21</span>
	<span class="n">cfi_st</span>		<span class="n">fp</span><span class="p">,</span> <span class="n">PT_R22</span>

	<span class="n">SAVE_STATIC</span>
	<span class="n">UNWIND_HINT_REGS</span>

<span class="c1">#ifdef CONFIG_KGDB</span>
	<span class="n">li</span><span class="o">.</span><span class="n">w</span>		<span class="n">t1</span><span class="p">,</span> <span class="n">CSR_CRMD_WE</span>
	<span class="n">csrxchg</span>		<span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">LOONGARCH_CSR_CRMD</span>
<span class="c1">#endif</span>

	<span class="n">move</span>		<span class="n">u0</span><span class="p">,</span> <span class="n">t0</span>
	<span class="n">li</span><span class="o">.</span><span class="n">d</span>		<span class="n">tp</span><span class="p">,</span> <span class="o">~</span><span class="n">_THREAD_MASK</span>
	<span class="ow">and</span>		<span class="n">tp</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">sp</span>

	<span class="n">move</span>		<span class="n">a0</span><span class="p">,</span> <span class="n">sp</span>
	<span class="n">bl</span>		<span class="n">do_syscall</span>

	<span class="n">RESTORE_ALL_AND_RET</span>
<span class="n">SYM_CODE_END</span><span class="p">(</span><span class="n">handle_syscall</span><span class="p">)</span>
</pre></div>
</div>
<p>通过执行do_syscall函数，来处理具体的系统调用！</p>
<hr class="docutils" />
<p>用户态使用下面的内敛汇编进入系统调用。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define SYSCALL_CLOBBERLIST \</span>
<span class="cp">	&quot;$t0&quot;, &quot;$t1&quot;, &quot;$t2&quot;, &quot;$t3&quot;, \</span>
<span class="cp">	&quot;$t4&quot;, &quot;$t5&quot;, &quot;$t6&quot;, &quot;$t7&quot;, &quot;$t8&quot;, &quot;memory&quot;</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">__syscall0</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a7</span><span class="w"> </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$a7&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$a0&quot;</span><span class="p">);</span>

<span class="w">	</span><span class="n">__asm__</span><span class="w"> </span><span class="n">__volatile__</span><span class="w"> </span><span class="p">(</span>
<span class="w">		</span><span class="s">&quot;syscall 0&quot;</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a7</span><span class="p">)</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="n">SYSCALL_CLOBBERLIST</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">__syscall1</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a7</span><span class="w"> </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$a7&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$a0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>

<span class="w">	</span><span class="n">__asm__</span><span class="w"> </span><span class="n">__volatile__</span><span class="w"> </span><span class="p">(</span>
<span class="w">		</span><span class="s">&quot;syscall 0&quot;</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;+r&quot;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a7</span><span class="p">)</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="n">SYSCALL_CLOBBERLIST</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">__syscall2</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a7</span><span class="w"> </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$a7&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a0</span><span class="w"> </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$a0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">	</span><span class="k">register</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$a1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>

<span class="w">	</span><span class="n">__asm__</span><span class="w"> </span><span class="n">__volatile__</span><span class="w"> </span><span class="p">(</span>
<span class="w">		</span><span class="s">&quot;syscall 0&quot;</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;+r&quot;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span>
<span class="w">	        </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a7</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="w">		</span><span class="o">:</span><span class="w"> </span><span class="n">SYSCALL_CLOBBERLIST</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">a0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id12">
<h2><span class="section-number">5.4.3. </span>非对齐访问<a class="headerlink" href="#id12" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>所有取指操作的访存地址必须 4 字节边界对齐，否则将触发取指地址错例外（ADEF）（<strong>这个是错误，一般都是终止进程</strong>）。</p></li>
<li><p>除了原子访存指令、整数边界检查访存指令和浮点数边界检查访存指令外，其余的 load/store 访存指令<br />
可以实现为允许访存地址不对齐。（<strong>这是架构允许的</strong>）</p></li>
</ol>
<p>不过，在一个允许访存地址不对齐的实现中，系统态软件可以通过配置<br />
CSR.MISC 中的 ALCL0~ALCL3 控制位，在 PLV0~PLV3 特权等级下，对这些 load/store 访存指令也进行地<br />
址对齐检查。对于需要进行地址对齐检查的访存指令，如果其访问的地址不是自然对齐1的，将触发地址非<br />
对齐例外（ALE）。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>除了以下指令：</p>
<ul class="simple">
<li><p>原子访存指令</p></li>
<li><p>整数边界检查访存指令</p></li>
<li><p>浮点数边界检查访存指令</p></li>
</ul>
<p>其余的Load/Store指令都支持非对齐访问。手册不强制实现！</p>
<p>但是在以下考虑成本的芯片中，也可以不实现硬件的非对齐访问。</p>
<p>处理的方式为：当检查访存指令为非对齐访问时，抛出ALE地址非对齐异常，
然后使用软件模拟此条访存指令的行为。</p>
</div>
<p>模拟非对齐访问的执行过程如下：</p>
<ul class="simple">
<li><p>检查load/store指令的地址是否对齐，如果不对齐则抛出ALE异常。</p></li>
<li><p>此时当前的指令PC保存在CSR.ERA中，非对齐的地址保存在CSR.BADV中。</p></li>
<li><p>然后进入非对齐访问的处理函数。</p></li>
<li><p>读取当前的指令通过CSR.ERA，返回软件译码分析当前的指令INSN。</p></li>
<li><p>然后获得当前出错指令的需要加载或者存储的字节数。</p></li>
<li><p>如果是load操作，从内存中按照字节读出内存，然后陪凑成目标的值，然后写入到目标寄存器。</p></li>
<li><p>如果是store操作，则将寄存器的值，按照字节负责到指定的CSR.BADV内存中。</p></li>
<li><p>然后CSR.ERA+4，执行下一条指令。</p></li>
<li><p>最好使用指令era返回。</p></li>
</ul>
<p>更加详细的代码可访问Linux内核源码<code class="docutils literal notranslate"><span class="pre">arch/loongarch/kernel/unaligned.c</span></code>。</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
    <a href="exception.html" class="btn btn-neutral float-left" title="5.2. 例外" accesskey="p"
      rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    <a href="../smp/index.html" class="btn btn-neutral float-right" title="6. SMP多核系统" accesskey="n"
      rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
  </div>

  <hr />

  <div role="contentinfo">
    <p>&#169; 版权所有 2022-2026, 龙芯中科技术有限公司。
      <span class="lastupdated">最后更新于 2026年2月10日 11:15:08.
      </span>

      <!-- 
      <span class="footer-aside">
        <a href="../../龙芯实验室文档.pdf" class="fa fa-file-pdf-o">&nbsp下载 PDF</a>
      </span>
       -->
    </p>
  </div> 

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>